---
title: "Work Doc - Palma"
author: "Palma"
date: "11/16/2021"
output: html_document
---


For the projects, I want to give some suggested due dates:

Friday 11/19: 3. Outline of analysis plan with some of the steps completed.

Tuesday 11/23: 1. Read in and clean other two sources of data. 2. Finish a couple of the analysis steps and write them up completely. I recommend focusing on the "final product" first. 3. Create an RMarkdown file for the "behind-the-scenes" report and be sure to keep track of any detailed explanations of methods and code there. 

Thursday 12/2: 1. Complete most of the analyses and have a draft of the "final product". 2. Begin creating a presentation. 3. Create a detailed outline of what will go in the "behind-the-scenes". 

Tuesday 12/7: 1. "Final product" complete. 2. Finish the 15 minute presentation and practice it with your group. 

Thursday 12/9: 1. Submit "final product" on moodle. 2. Give presentations - we may need to use a bit of the lunch hour. 

Thursday 12/16: Submit "behind-the-scenes" (you can always submit early, if you'd like). 


```{r}
library(nflfastR)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(stringr)
library(lubridate)

library(tidymodels)        # for modeling
library(themis)            # for step functions for unbalanced data
library(doParallel)        # for parallel processing
library(stacks)            # for stacking models
library(naniar)            # for examining missing values (NAs)
library(moderndive)        # for King County housing data
library(vip)               # for variable importance plots
library(patchwork)         # for combining plots nicely
library(ranger)
library(xgboost)
pbp_2021 <- load_pbp(2021)
```


```{r}
#devtools::install_github(repo = "ryurko/nflscrapR")
```


```{r}
library(nflscrapR)

```


```{r}
two_min_drill <- pbp_2021 %>% 
  filter(half_seconds_remaining<120, as.numeric(ms(drive_game_clock_start))<150) 
  
two_min_new <- two_min_drill %>% 
  group_by(game_id, drive) %>%
  mutate(td = ifelse(fixed_drive_result=='Touchdown', 1, 0),
  fg = ifelse(fixed_drive_result=='Field goal', 1, 0), 
  score= ifelse(td+fg==1, 1,0)) %>%
  ungroup()

```


```{r}
two_min_by_drive <- 
  two_min_drill %>%
    group_by(drive, game_id) %>%
    mutate(run_plays = sum(rush_attempt, na.rm = TRUE), 
           pass_plays = sum(pass_attempt, na.rm = TRUE), 
           pass_tot_yds = sum(air_yards, na.rm = TRUE), 
           completion_perc = (1- sum(incomplete_pass, na.rm = TRUE) / pass_plays), 
           penalties = sum(penalty, na.rm = TRUE), 
           tot_yds = sum(yards_gained, na.rm = TRUE),
           rush_yds_tot = sum(rushing_yards, na.rm = TRUE)) %>% 
     mutate(td = ifelse(fixed_drive_result=='Touchdown', 1, 0),
            fg = ifelse(fixed_drive_result=='Field goal', 1, 0), 
            score= ifelse(td+fg==1, 1,0)) %>%
    select(pass_tot_yds, tot_yds, rush_yds_tot, completion_perc, run_plays, pass_plays, penalties, drive_yards_penalized, tot_yds, drive_game_clock_start, td, fg, score)
```


```{r}
two_min_by_drive
```

```{r}
drive_summary_data <- two_min_by_drive %>%
 arrange(game_id, drive) %>% 
 group_by(game_id) %>% 
  mutate(
    td = as.factor(td), 
    fg = as.factor(fg), 
    score = as.factor(score)
  ) %>%
 summarise_all(last)

drive_summary_data
```

## Exploratory Work



```{r}
drive_summary_data %>%
  count(game_id)
```

```{r}
drive_summary_data %>%
  count(drive)
```

```{r}
drive_summary_data %>%
  count(completion_perc)
```

```{r}
drive_summary_data %>%
  count(td)
```

```{r}
drive_summary_data %>%
  count(fg)
```

```{r}
drive_summary_data %>%
  count(score)
```


1.  Exploring Data


**Quant Vars**

```{r}
drive_summary_data %>% 
  select(where(is.numeric)) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(vars(variable), 
             scales = "free", 
            nrow = 3)

```

**Categorical**

```{r}
drive_summary_data %>%
select(where(is.character)) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_bar() +
  facet_wrap(vars(variable), 
             scales = "free", 
             nrow = 3)
```

2.  Training / Testing 


```{r}
set.seed(2)

drive_two_min_split <- initial_split(drive_summary_data, 
                             prop = .75, strata = "score")

drive_two_min_training <- training(drive_two_min_split)
drive_two_min_testing <- testing(drive_two_min_split)
```


3. Set up the recipe and the pre-processing steps to build a lasso model

```{r}
set.seed(2)

lasso_recipe <- recipe(score ~ ., 
                       data = drive_two_min_training) %>% 
  step_upsample(score, over_ratio = 0.5) %>%
  step_downsample(score, under_ratio = 1) %>%
  step_mutate_at(all_numeric(), 
                fn = ~ as.numeric(.)) %>%
  step_dummy(all_nominal(), 
             -all_outcomes(), -game_id, -drive_game_clock_start) #%>% 
  #step_normalize(all_predictors(), 
                 #-all_nominal(), -drive, -pass_tot_yds, -tot_yds)
```


```{r}
lasso_recipe %>% 
  prep(drive_two_min_training) %>%
  juice() 
```


# Lasso Model and WF

```{r}
lasso_mod  <- 
  logistic_reg(mixture = 1) %>% 
  set_engine("glmnet") %>% 
  set_args(penalty = tune()) %>% 
  set_mode("classification")

lasso_wf <-  workflow() %>% 
  add_recipe(lasso_recipe) %>% 
  add_model(lasso_mod)

```

# More Lasso Set up

```{r}
set.seed(2) #for reproducible 5-fold
drive_two_min_cv <- vfold_cv(drive_two_min_training, v = 5)


penalty_grid <- grid_regular(penalty(),
                             levels = 10)

ctrl_grid <- control_stack_grid()

lasso_tune <-  
  lasso_wf %>% 
  tune_grid(
    resamples = drive_two_min_cv,
    grid = penalty_grid,
    control = ctrl_grid)

lasso_tune %>% 
  select(id, .metrics) %>% 
  unnest(.metrics) %>% 
  filter(.metric == "accuracy")
```

```{r}
lasso_tune %>% 
  collect_metrics() %>% 
  filter(.metric == "accuracy") %>% 
  ggplot(aes(x = penalty, y = mean)) +
  geom_point() +
  geom_line() +
  scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10",scales::math_format(10^.x))) +
  labs(x = "penalty", y = "accuracy")
```


```{r}
lasso_tune %>% 
  show_best(metric = "accuracy")
```

```{r}
best_param <- lasso_tune %>% 
  select_best(metric = "accuracy")
best_param
```


```{r}
lasso_tune %>%
  select_best(metric = "accuracy")
```

# RF WORK

```{r}
set.seed(2)

rf_recipe <-  
  recipe(score ~ ., 
        data = drive_two_min_training) %>% 
  step_upsample(score, over_ratio = 0.5) %>%
  step_downsample(score, under_ratio = 1) %>%
  step_mutate_at(all_numeric(), 
                fn = ~ as.numeric(.))
```

```{r}
rf_model <- rand_forest(mtry = tune(), 
              min_n = tune(), 
              trees = 100) %>% 
  set_mode("classification") %>% 
  set_engine("ranger")

rf_workflow <- workflow() %>% 
  add_recipe(rf_recipe) %>% 
  add_model(rf_model) 
```

```{r}
rf_penalty_grid <- grid_regular(
  finalize(mtry(), drive_two_min_training %>% select(-score)),
  min_n(),
  levels = 3)


rf_tune <- 
  rf_workflow %>% 
  tune_grid(
    resamples = drive_two_min_cv, 
    grid = rf_penalty_grid, 
    control = control_stack_grid())
```

```{r}
rf_tune %>%
  select_best(metric = "accuracy")
```

